name: Deploy All

on:
    workflow_dispatch:

permissions:
    id-token: write
    contents: read

env:
    ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
    ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    ARM_USE_OIDC: true
    TF_VAR_APP_KEY: ${{ secrets.TF_VAR_APP_KEY }}
    SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}

jobs:
    deploy-shared:
        name: Deploy Shared Infrastructure
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Terragrunt
              uses: ./.github/actions/setup-terragrunt
              with:
                  azure_client_id: ${{ secrets.AZURE_CLIENT_ID }}
                  azure_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
                  azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Deploy Shared Infrastructure
              working-directory: terragrunt/shared
              run: |
                  terragrunt init
                  terragrunt apply -auto-approve

    trigger-parallel-builds:
        runs-on: ubuntu-latest
        needs: [deploy-shared]
        strategy:
            fail-fast: false # If one env fails, don't cancel the other
            matrix:
                include:
                    - env: prod
                      branch: main
                    - env: qa
                      branch: qa

        # Use the environment from the matrix to scope secrets if needed
        environment: ${{ matrix.env }}

        steps:
            - name: Trigger App Build (${{ matrix.env }})
              uses: convictional/trigger-workflow-and-wait@v1.6.1
              with:
                  owner: ratataque
                  repo: terra_cloud
                  github_token: ${{ secrets.APP_REPO_PAT }}
                  workflow_file_name: build-and-push.yml
                  ref: ${{ matrix.branch }}
                  wait_interval: 10
                  propagate_failure: true
                  trigger_workflow: true
                  wait_workflow: true

    deploy-qa:
        name: Deploy QA Environments
        runs-on: ubuntu-latest
        needs: [deploy-shared, trigger-parallel-builds]
        environment: qa
        strategy:
            matrix:
                deployment: [iaas, paas]
            fail-fast: false

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Terragrunt
              uses: ./.github/actions/setup-terragrunt
              with:
                  azure_client_id: ${{ secrets.AZURE_CLIENT_ID }}
                  azure_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
                  azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Deploy QA ${{ matrix.deployment }} Infrastructure
              working-directory: terragrunt/${{ matrix.deployment }}/qa
              run: |
                  terragrunt init
                  terragrunt apply -auto-approve

    deploy-prod:
        name: Deploy Production Environments
        runs-on: ubuntu-latest
        needs: [deploy-shared, trigger-parallel-builds]
        environment: prod
        strategy:
            matrix:
                deployment: [iaas, paas]
            fail-fast: false

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Terragrunt
              uses: ./.github/actions/setup-terragrunt
              with:
                  azure_client_id: ${{ secrets.AZURE_CLIENT_ID }}
                  azure_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
                  azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Deploy Production ${{ matrix.deployment }} Infrastructure
              working-directory: terragrunt/${{ matrix.deployment }}/prod
              run: |
                  terragrunt init
                  terragrunt apply -auto-approve
