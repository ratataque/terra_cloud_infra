name: Infrastructure Deploy

on:
    push:
        branches: [main]
        paths:
            - "terragrunt/**"
            - ".github/workflows/infra-deploy.yml"
    workflow_dispatch:

permissions:
    id-token: write
    contents: read

env:
    ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
    ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    ARM_USE_OIDC: true
    TF_VAR_APP_KEY: ${{ secrets.TF_VAR_APP_KEY }}

jobs:
    deploy-shared:
        name: Deploy Shared Infrastructure
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Terragrunt
              uses: ./.github/actions/setup-terragrunt
              with:
                  azure_client_id: ${{ secrets.AZURE_CLIENT_ID }}
                  azure_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
                  azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Deploy Shared Infrastructure
              working-directory: terragrunt/shared
              run: |
                  terragrunt init
                  terragrunt apply -auto-approve

    deploy-qa:
        name: Deploy QA Environments
        runs-on: ubuntu-latest
        needs: [deploy-shared]
        environment: qa
        strategy:
            matrix:
                deployment: [iaas, paas]
            fail-fast: false

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Terragrunt
              uses: ./.github/actions/setup-terragrunt
              with:
                  azure_client_id: ${{ secrets.AZURE_CLIENT_ID }}
                  azure_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
                  azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Deploy QA ${{ matrix.deployment }} Infrastructure
              working-directory: terragrunt/${{ matrix.deployment }}/qa
              run: |
                  terragrunt init
                  terragrunt apply -auto-approve

    deploy-prod:
        name: Deploy Production Environments
        runs-on: ubuntu-latest
        needs: [deploy-shared]
        environment: prod
        strategy:
            matrix:
                deployment: [iaas, paas]
            fail-fast: false

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Terragrunt
              uses: ./.github/actions/setup-terragrunt
              with:
                  azure_client_id: ${{ secrets.AZURE_CLIENT_ID }}
                  azure_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
                  azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Deploy Production ${{ matrix.deployment }} Infrastructure
              working-directory: terragrunt/${{ matrix.deployment }}/prod
              run: |
                  terragrunt init
                  terragrunt apply -auto-approve
