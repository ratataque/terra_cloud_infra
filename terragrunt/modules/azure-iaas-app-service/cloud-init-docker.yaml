#cloud-config
package_update: true
package_upgrade: false # Skip full upgrade for faster boot

packages:
    - docker.io
    - docker-compose-plugin
    - curl

write_files:
    # docker-compose.yml for IaaS with Traefik + App + MySQL
    # Traefik enables rolling updates during CD via Ansible
    - path: /opt/app/docker-compose.yml
      permissions: "0644"
      content: |
          services:
            traefik:
              image: "traefik:v3.0"
              container_name: traefik
              restart: unless-stopped
              command:
                - "--providers.docker=true"
                - "--providers.docker.exposedbydefault=false"
                - "--entrypoints.web.address=:80"
                - "--metrics.prometheus=false"
              ports:
                - "80:80"
              volumes:
                - "/var/run/docker.sock:/var/run/docker.sock:ro"
              networks:
                - app-net
            
            db:
              image: mysql:8.0
              container_name: db
              restart: unless-stopped
              command: --default-authentication-plugin=mysql_native_password
              environment:
                MYSQL_DATABASE: ${db_name}
                MYSQL_USER: ${db_username}
                MYSQL_PASSWORD: ${db_password}
                MYSQL_ROOT_PASSWORD: ${db_root_password}
                MYSQL_TCP_PORT: 3306
              volumes:
                - db_data:/var/lib/mysql
              networks:
                - app-net
              healthcheck:
                test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
                timeout: 5s
                retries: 10
            
            app:
              image: ${acr_login_server}/${docker_image}:${docker_image_tag}
              container_name: app
              restart: unless-stopped
              environment:
                APP_KEY: "${app_key}"
                APP_ENV: "${lookup(jsondecode(app_settings), "APP_ENV", "production")}"
                APP_DEBUG: "${lookup(jsondecode(app_settings), "APP_DEBUG", "false")}"
                APP_URL: "${lookup(jsondecode(app_settings), "APP_URL", "http://localhost")}"
                LOG_LEVEL: "${lookup(jsondecode(app_settings), "LOG_LEVEL", "info")}"
                DB_CONNECTION: mysql
                DB_HOST: db
                DB_PORT: 3306
                DB_DATABASE: ${db_name}
                DB_USERNAME: ${db_username}
                DB_PASSWORD: ${db_password}
              depends_on:
                db:
                    condition: service_healthy
              networks:
                - app-net
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.app.rule=HostRegexp(`.*`)"
                - "traefik.http.services.app.loadbalancer.server.port=80"

          volumes:
            db_data:

          networks:
            app-net:
              driver: bridge

    # Service systemd pour gÃ©rer la stack Docker
    - path: /etc/systemd/system/app-stack.service
      permissions: "0644"
      content: |
          [Unit]
          Description=Docker Compose App Stack
          Requires=docker.service
          After=docker.service

          [Service]
          WorkingDirectory=/opt/app
          ExecStart=/usr/bin/docker compose up -d
          ExecStop=/usr/bin/docker compose down
          Restart=always
          TimeoutStartSec=0

          [Install]
          WantedBy=multi-user.target

runcmd:
    # Install Docker packages
    - sudo apt-get update
    - sudo apt-get install -y ca-certificates curl
    - sudo install -m 0755 -d /etc/apt/keyrings
    - sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
    - sudo chmod a+r /etc/apt/keyrings/docker.asc

    # Add the repository to Apt sources:
    - echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
      $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
      sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

    # 3. Install Docker Engine and Compose Plugin
    - sudo apt-get update
    - sudo apt-get install -y docker.io docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

    # 4. (Optional) Allow running docker without sudo
    # This adds your current user 'azureuser' (or similar) to the docker group
    - sudo usermod -aG docker $USER
    - newgrp docker

    # Create app directory
    - mkdir -p /opt/app

    # Add azureuser to docker group
    - usermod -aG docker azureuser

    # Enable and start Docker
    - systemctl enable docker
    - systemctl start docker

    # Login to ACR using credentials
    - sleep 30
    - docker login ${acr_login_server} -u ${acr_admin_username} -p ${acr_admin_password}

    # Pull the initial app image
    - docker pull ${acr_login_server}/${docker_image}:${docker_image_tag}

    # Start the Docker Compose stack (Traefik + DB + App)
    # - systemctl daemon-reload
    # - systemctl enable app-stack
    # - systemctl start app-stack

final_message: "TerraCloud IaaS VM ready: Traefik + MySQL + App running. Ansible will handle rolling deployments."
