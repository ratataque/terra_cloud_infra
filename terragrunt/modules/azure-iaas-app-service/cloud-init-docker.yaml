#cloud-config
# package_update: true
# package_upgrade: false # Skip full upgrade for faster boot
#
# packages:
#     # - docker.io
#     # - docker-compose-plugin
#     - curl

write_files:
    # docker-compose.yml for IaaS with Traefik + App + MySQL
    # Traefik enables rolling updates during CD via Ansible
    - path: /opt/app/docker-compose.yml
      permissions: "0644"
      content: |
          services:
            traefik:
              image: "traefik:v3.0"
              container_name: traefik
              restart: unless-stopped
              command:
                - "--providers.docker=true"
                - "--providers.docker.exposedbydefault=false"
                - "--entrypoints.web.address=:80"
                - "--metrics.prometheus=false"
              ports:
                - "80:80"
              volumes:
                - "/var/run/docker.sock:/var/run/docker.sock:ro"
              networks:
                - app-net
            
            db:
              image: mysql:8.0
              container_name: db
              restart: unless-stopped
              command: --default-authentication-plugin=mysql_native_password
              environment:
                MYSQL_DATABASE: ${db_name}
                MYSQL_USER: ${db_username}
                MYSQL_PASSWORD: ${db_password}
                MYSQL_ROOT_PASSWORD: ${db_root_password}
                MYSQL_TCP_PORT: 3306
              volumes:
                - db_data:/var/lib/mysql
              networks:
                - app-net
              healthcheck:
                test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
                timeout: 5s
                retries: 10
            
            app:
              image: ${acr_login_server}/${docker_image}:${docker_image_tag}
              container_name: app
              restart: unless-stopped
              environment:
                APP_KEY: "${app_key}"
                APP_ENV: "${lookup(jsondecode(app_settings), "APP_ENV", "production")}"
                APP_DEBUG: "${lookup(jsondecode(app_settings), "APP_DEBUG", "false")}"
                APP_URL: "${lookup(jsondecode(app_settings), "APP_URL", "http://localhost")}"
                LOG_LEVEL: "${lookup(jsondecode(app_settings), "LOG_LEVEL", "info")}"
                DB_CONNECTION: mysql
                DB_HOST: db
                DB_PORT: 3306
                DB_DATABASE: ${db_name}
                DB_USERNAME: ${db_username}
                DB_PASSWORD: ${db_password}
              depends_on:
                db:
                    condition: service_healthy
              networks:
                - app-net
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.app.rule=HostRegexp(`.*`)"
                - "traefik.http.services.app.loadbalancer.server.port=80"

          volumes:
            db_data:

          networks:
            app-net:
              driver: bridge

    # Service systemd pour g√©rer la stack Docker
    - path: /etc/systemd/system/app-stack.service
      permissions: "0644"
      content: |
          [Unit]
          Description=Docker Compose App Stack
          Requires=docker.service
          After=docker.service

          [Service]
          WorkingDirectory=/opt/app
          ExecStart=/usr/bin/docker compose up -d
          ExecStop=/usr/bin/docker compose down
          Restart=always
          TimeoutStartSec=0

          [Install]
          WantedBy=multi-user.target

runcmd:
    # Install Docker manually to control memory usage
    # - sudo apt-get install -y docker.io
    # - sudo apt-get install -y docker-compose

    # Create app directory
    - mkdir -p /opt/app

    # Add azureuser to docker group
    - usermod -aG docker azureuser

    # Enable and start Docker
    - sudo systemctl enable docker
    - sudo systemctl start docker

    # Wait for Docker to be ready
    # - sleep 10

    # Login to ACR using credentials
    # - sudo docker login ${acr_login_server} -u ${acr_admin_username} -p ${acr_admin_password}

    # Pull the initial app image
    # - docker pull ${acr_login_server}/${docker_image}:${docker_image_tag}

    # Start the Docker Compose stack (commented for manual debugging)
    # - cd /opt/app && docker compose up -d

final_message: "TerraCloud IaaS VM ready: Traefik + MySQL + App running. Ansible will handle rolling deployments."
